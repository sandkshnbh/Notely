<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Notely</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Default Dark Theme Variables */
            --background-main: #101010;
            --text-primary: #B8CC2E; /* أصفر مخضر */
            --text-secondary: #8A8A8E;
            --ios-element-bg: #1C1C1E;
            --ios-element-bg-softer: #272729;
            --ios-border-color: #3A3A3C;
            --ios-accent-color: var(--text-primary);
            --dark-for-checkmark: #101010;
            --strike-through: #6D6D70;
            --priority-high: #FF6B6B;
            --priority-medium: #FFD966;
            --priority-low: #76C7C0;
            --modal-backdrop: rgba(0, 0, 0, 0.7);
            --sound-toggle-bg: #555;
            --sound-toggle-knob: #f1f1f1;

            /* Elegant Fonts */
            --font-arabic: 'El Messiri', 'Tajawal', sans-serif;
            --font-english: 'Montserrat', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .light-theme {
            --background-main: #F0F2F5; /* Light gray background */
            --text-primary: #2c3e50; /* Darker text for light theme */
            --text-secondary: #7f8c8d;
            --ios-element-bg: #FFFFFF; /* White elements */
            --ios-element-bg-softer: #F8F9FA;
            --ios-border-color: #DEE2E6; /* Light border */
            --ios-accent-color: #007AFF; /* iOS blue as accent for light theme */
            --dark-for-checkmark: #FFFFFF; /* White for checkmark on colored bg */
            --strike-through: #bdc3c7;
            --modal-backdrop: rgba(0, 0, 0, 0.4);
            --sound-toggle-bg: #ccc;
            --sound-toggle-knob: #fff;
        }


        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-english); /* Default to English font stack */
            background-color: var(--background-main);
            color: var(--text-primary);
            margin: 0;
            padding: 20px 20px 90px 20px; /* Increased padding-bottom for taller nav bar */
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }
        body.lang-ar { font-family: var(--font-arabic); }
        body.lang-en { font-family: var(--font-english); }


        .view { display: none; width: 100%; }
        .view.active { display: block; animation: viewFadeIn 0.3s ease-out; }
        @keyframes viewFadeIn { from { opacity: 0; } to { opacity: 1; } }

        .container { width: 100%; max-width: 600px; margin-top: 10px; }

        header { text-align: center; margin-bottom: 20px; }
        header h1 {
            color: var(--text-primary);
            font-size: 2.2em; /* Slightly larger for "Notely" */
            margin: 0; font-weight: 700;
        }
        body.lang-ar header h1 { font-family: var(--font-arabic); }
        body.lang-en header h1 { font-family: var(--font-english); font-weight: 600;}
        
        .input-area {
            display: flex; gap: 10px; margin-bottom: 15px;
            background-color: var(--ios-element-bg);
            padding: 10px; border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .light-theme .input-area { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }


        .task-input {
            flex-grow: 1; padding: 12px 15px; border: none; border-radius: 8px;
            font-size: 1em; background-color: var(--ios-element-bg-softer);
            color: var(--text-primary); outline: none;
        }
        body.lang-ar .task-input { font-family: var(--font-arabic); }
        body.lang-en .task-input { font-family: var(--font-english); }
        .task-input::placeholder { color: var(--text-secondary); font-weight: 400; }

        .add-btn {
            background-color: var(--ios-accent-color); color: var(--dark-for-checkmark); /* White/Black text on accent */
            border: none; padding: 10px; min-width: 48px; height: 48px;
            border-radius: 8px; font-size: 1.5em; /* For FA icon */
            cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex; align-items: center; justify-content: center; line-height: 1;
        }
        .add-btn:hover { filter: brightness(1.1); }
        .add-btn:active { transform: scale(0.95); }

        .task-stats { font-size: 0.9em; color: var(--text-secondary); text-align: center; margin-bottom: 15px; }

        .task-list {
            list-style: none; padding: 0; margin: 0;
            background-color: var(--ios-element-bg);
            border-radius: 12px; overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .light-theme .task-list { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }


        .task-item {
            padding: 12px 15px; display: flex; flex-direction: column;
            border-bottom: 1px solid var(--ios-border-color);
            transition: background-color 0.2s ease, opacity 0.4s ease, transform 0.4s ease;
        }
        .task-item:last-child { border-bottom: none; }
        
        .task-main-content { display: flex; align-items: center; justify-content: space-between; width: 100%;}
        .task-details-content { margin-top: 8px; padding-right: 30px; }

        .task-info { display: flex; align-items: center; flex-grow: 1; min-width: 0; }
        
        .priority-indicator { width: 10px; height: 10px; border-radius: 50%; margin-left: 10px; margin-right: 5px; flex-shrink: 0;}
        /* Priority colors are already defined */

        .task-text { font-size: 1.05em; font-weight: 500; margin-right: 8px; word-break: break-word; flex-grow: 1; min-width: 0; }
        body.lang-ar .task-text { font-family: var(--font-arabic); }
        body.lang-en .task-text { font-family: var(--font-english); }
        .task-item.completed .task-text { text-decoration: line-through; text-decoration-color: var(--strike-through); color: var(--strike-through); font-weight: 400;}
        
        .task-extras { font-size: 0.85em; color: var(--text-secondary); margin-top: 6px; }
        .task-extras p { margin: 2px 0; }
        .task-notes-display { font-style: italic; white-space: pre-wrap; word-break: break-word; }

        .task-image-container { position: relative; margin-left: 8px; }
        .task-image-thumbnail {
            width: 28px; height: 28px; border-radius: 6px; object-fit: cover;
            cursor: pointer; vertical-align: middle; display: block;
        }
        .remove-image-btn {
            position: absolute; top: -5px; right: -5px; /* Adjusted for LTR/RTL */
            background-color: rgba(0,0,0,0.6); color: white;
            border-radius: 50%; width: 16px; height: 16px;
            font-size: 10px; line-height: 16px; text-align: center;
            cursor: pointer; display: none; z-index: 1;
        }
        .task-image-container:hover .remove-image-btn { display: block; }
        body[dir="rtl"] .remove-image-btn { right: auto; left: -5px; }


        .checkbox-container { /* Kept custom checkbox for iOS feel */
            display: inline-flex; align-items: center; justify-content: center;
            position: relative; cursor: pointer; width: 24px; height: 24px;
            margin-left: 10px; user-select: none; flex-shrink: 0;
        }
        .checkbox-container input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .checkmark {
            position: absolute; top: 0; left: 0; height: 24px; width: 24px;
            background-color: transparent; border: 2px solid var(--ios-accent-color);
            border-radius: 50%; transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .checkbox-container input:checked ~ .checkmark { background-color: var(--ios-accent-color); border-color: var(--ios-accent-color); }
        .checkmark:after {
            content: ""; position: absolute; display: none;
            left: 7.5px; top: 4px; width: 6px; height: 11px;
            border: solid var(--dark-for-checkmark); border-width: 0 2.5px 2.5px 0;
            transform: rotate(45deg);
        }
        .checkbox-container input:checked ~ .checkmark:after { display: block; }

        .delete-btn {
            background: none; border: none; color: var(--text-secondary);
            font-size: 1.3em; /* For FA icon */ cursor: pointer;
            padding: 8px; line-height: 1; opacity: 0.7; flex-shrink: 0;
            transition: color 0.2s ease, transform 0.1s ease;
        }
        .task-item:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: var(--priority-high); } /* Red for delete hover */
        .delete-btn:active { transform: scale(0.9); }


        /* Image Modal */
        .image-modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: var(--modal-backdrop);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            justify-content: center; align-items: center;
        }
        .image-modal img { max-width: 90%; max-height: 80%; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.3); }
        .image-modal .close-modal-btn {
            position: absolute; top: 25px; 
            color: white; font-size: 1.8em; /* For FA icon */ font-weight: bold; cursor: pointer;
            background-color: rgba(0,0,0,0.4); border-radius: 50%; width:44px; height:44px;
            display:flex; align-items:center; justify-content:center; line-height:1;
            transition: background-color 0.2s;
        }
        .image-modal .close-modal-btn:hover { background-color: rgba(0,0,0,0.7); }
        body[dir="rtl"] .image-modal .close-modal-btn { right: auto; left: 25px; }
        body[dir="ltr"] .image-modal .close-modal-btn { right: 25px; left: auto; }


        /* Settings View & About View */
        .settings-section, .about-section { padding: 20px; background-color: var(--ios-element-bg); border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);}
        .light-theme .settings-section, .light-theme .about-section { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

        .settings-section h2, .about-section h2 { font-size: 1.6em; margin-top: 0; margin-bottom: 20px; color: var(--text-primary); font-weight: 600;}
        body.lang-ar .settings-section h2, body.lang-ar .about-section h2 { font-family: var(--font-arabic); }
        body.lang-en .settings-section h2, body.lang-en .about-section h2 { font-family: var(--font-english); }

        .settings-item { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;}
        .settings-item label { font-size: 1.05em; }
        body.lang-ar .settings-item label { font-family: var(--font-arabic); }
        body.lang-en .settings-item label { font-family: var(--font-english); }

        .settings-item select, .settings-item button:not(.add-btn):not(.delete-btn) {
            background-color: var(--ios-element-bg-softer); color: var(--text-primary);
            border: 1px solid var(--ios-border-color); border-radius: 8px; padding: 10px 15px;
            font-size: 0.95em;
        }
        body.lang-ar .settings-item select, body.lang-ar .settings-item button { font-family: var(--font-arabic); }
        body.lang-en .settings-item select, body.lang-en .settings-item button { font-family: var(--font-english); }

        .settings-item button:not(.add-btn):not(.delete-btn) { cursor: pointer; transition: background-color 0.2s; }
        .settings-item button:hover:not(.add-btn):not(.delete-btn) { filter: brightness(1.1); }

        /* Toggle Switch for Theme & Sound */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--sound-toggle-bg); transition: .3s; border-radius: 28px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px;
            background-color: var(--sound-toggle-knob); transition: .3s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--ios-accent-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        .about-section p { font-size: 1em; line-height: 1.7; margin-bottom: 12px; }
        body.lang-ar .about-section p { font-family: var(--font-arabic); }
        body.lang-en .about-section p { font-family: var(--font-english); }
        .about-section strong { font-weight: 600; color: var(--text-primary); }


        /* Add Task Details Form */
        .add-task-details-form {
            background-color: var(--ios-element-bg); padding: 15px;
            border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--ios-border-color);
        }
        .add-task-details-form h3 { margin-top:0; font-size: 1.2em; font-weight: 600; }
        .add-task-details-form label { display: block; margin-bottom: 6px; font-size: 0.95em; color: var(--text-secondary); }
        .add-task-details-form input[type="text"],
        .add-task-details-form textarea,
        .add-task-details-form select {
            width: 100%; padding: 10px; margin-bottom: 12px;
            background-color: var(--ios-element-bg-softer); color: var(--text-primary);
            border: 1px solid var(--ios-border-color); border-radius: 8px; font-size: 0.95em;
        }
        .add-task-details-form input[type="file"] { padding: 8px; font-size: 0.85em; }


        /* Bottom Nav Bar */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            display: flex; justify-content: space-around; align-items: stretch; /* Stretch for equal height */
            background-color: var(--ios-element-bg);
            border-top: 1px solid var(--ios-border-color);
            padding: 5px 0; z-index: 100; height: 65px; /* Fixed height */
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .light-theme .bottom-nav { box-shadow: 0 -2px 8px rgba(0,0,0,0.08); }

        .nav-btn {
            background: none; border: none; color: var(--text-secondary);
            cursor: pointer; font-size: 0.7em; /* Smaller text for icon emphasis */ text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center; /* Center content */
            padding: 5px 8px; border-radius: 8px; transition: color 0.2s, background-color 0.2s;
            flex-grow: 1; /* Equal width */
        }
        .nav-btn.active { color: var(--ios-accent-color); }
        .nav-btn:hover:not(.active) { background-color: var(--ios-element-bg-softer); }
        .nav-btn .nav-icon { font-size: 1.6em; margin-bottom: 4px; width: 24px; /* Fixed width for icon */ } 

        footer { text-align: center; margin-top: 25px; padding-bottom: 10px; font-size: 0.9em; color: var(--text-secondary); }
        footer p { margin: 4px 0; }
        body.lang-ar footer p, body.lang-ar footer .dev-name { font-family: var(--font-arabic); }
        body.lang-en footer p, body.lang-en footer .dev-name { font-family: var(--font-english); }
        footer .dev-name { font-weight: 600; color: var(--ios-accent-color); }

        .task-item.fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .task-item.fade-out { animation: fadeOutiOS 0.4s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOutiOS { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.98); } }

    </style>
</head>
<body>
    <div id="homeView" class="view active">
        <div class="container">
            <header>
                <h1 data-lang-key="appName">Notely</h1>
            </header>
            <div class="input-area">
                <input type="text" id="taskInput" class="task-input" data-lang-placeholder="addPlaceholder">
                <button id="addTaskBtn" class="add-btn" data-lang-aria-label="addTaskAriaLabel">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="taskDetailsForm" class="add-task-details-form" style="display: none;">
                <h3 data-lang-key="taskDetailsTitle">تفاصيل المهمة</h3>
                <label for="taskNotesInput" data-lang-key="notesLabel">ملاحظات:</label>
                <textarea id="taskNotesInput" rows="2"></textarea>
                
                <label for="taskPriorityInput" data-lang-key="priorityLabel">الأولوية:</label>
                <select id="taskPriorityInput">
                    <option value="low" data-lang-key="priorityLow">منخفضة</option>
                    <option value="medium" selected data-lang-key="priorityMedium">متوسطة</option>
                    <option value="high" data-lang-key="priorityHigh">عالية</option>
                </select>

                <label for="taskDueDateInput" data-lang-key="dueDateLabel">تاريخ الاستحقاق (اختياري):</label>
                <input type="text" id="taskDueDateInput" data-lang-placeholder="dueDatePlaceholder">
                
                <label for="taskImageInput" data-lang-key="imageLabel">إرفاق صورة (صغيرة):</label>
                <input type="file" id="taskImageInput" accept="image/*">
                <button id="confirmAddTaskBtn" style="width:100%; margin-top:15px; padding: 12px; font-size: 1em; background-color: var(--ios-accent-color); color: var(--dark-for-checkmark);" data-lang-key="confirmAddBtn">تأكيد وإضافة المهمة</button>
            </div>

            <div id="taskStats" class="task-stats"></div>
            <ul id="taskList" class="task-list"></ul>
        </div>
    </div>

    <div id="settingsView" class="view">
        <div class="container">
            <header> <h1 data-lang-key="settingsTitle">الإعدادات</h1> </header>
            <div class="settings-section">
                <div class="settings-item">
                    <label for="languageSwitcher" data-lang-key="languageLabel">اللغة:</label>
                    <select id="languageSwitcher">
                        <option value="ar">العربية (Arabic)</option>
                        <option value="en">English (الإنجليزية)</option>
                    </select>
                </div>
                 <div class="settings-item">
                    <label data-lang-key="themeLabel">المظهر (داكن/فاتح):</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="themeSwitcherToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <label data-lang-key="soundLabel">المؤثرات الصوتية:</label>
                     <label class="toggle-switch">
                        <input type="checkbox" id="soundToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <hr style="border-color: var(--ios-border-color); margin: 25px 0;">
                <div class="settings-item">
                    <button id="clearCompletedBtn" data-lang-key="clearCompletedBtn" style="background-color: var(--priority-medium); color: #333;"><i class="fas fa-broom" style="margin-left: 8px; margin-right: 8px;"></i> مسح المنجز</button>
                </div>
            </div>
        </div>
    </div>

    <div id="aboutView" class="view">
        <div class="container">
            <header> <h1 data-lang-key="aboutTitle">حول Notely</h1> </header>
            <div class="about-section">
                <p><strong data-lang-key="appName">Notely</strong> <span data-lang-key="isAnApp">هو تطبيق</span> <span data-lang-key="appDescriptionShort">أنيق وبسيط يساعدك على تنظيم مهامك وأفكارك اليومية بكل سهولة وجمال.</span></p>
                <p data-lang-key="appMission">مهمتنا هي توفير أداة مريحة للعين وسهلة الاستخدام تجعل تدوين الملاحظات وإدارة المهام تجربة ممتعة ومنتجة.</p>
                <h3 style="margin-top: 20px; font-weight:600;" data-lang-key="featuresTitle">أبرز الميزات:</h3>
                <ul style="line-height: 1.8; padding-right: 20px; padding-left: 20px;">
                    <li data-lang-key="featureAddTask">إضافة مهام سريعة مع تفاصيل اختيارية (ملاحظات، أولوية، تاريخ استحقاق، صورة مصغرة).</li>
                    <li data-lang-key="featureLangSupport">دعم لغتين: العربية والإنجليزية.</li>
                    <li data-lang-key="featureThemes">مظهران: داكن أنيق وفاتح مريح.</li>
                    <li data-lang-key="featureSounds">مؤثرات صوتية تفاعلية (يمكن إيقافها).</li>
                    <li data-lang-key="featureImagePreview">معاينة الصور المرفقة بحجم أكبر مع خلفية ضبابية.</li>
                    <li data-lang-key="featureLocalStorage">حفظ جميع بياناتك محلياً في المتصفح (تعمل بدون انترنت).</li>
                </ul>
                <p style="margin-top: 20px;"><span data-lang-key="version">الإصدار:</span> 3.0</p>
                <p><span data-lang-key="developedBy">تم التطوير بحُب بواسطة:</span> <span class="dev-name" style="font-weight:700;">سند كشنبه Sand Kshnbh</span></p>
                <p data-lang-key="feedbackWelcome">نرحب دائماً بآرائكم واقتراحاتكم لتطوير Notely!</p>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button id="navHomeBtn" class="nav-btn active" data-lang-aria-label="navHomeAria">
            <span class="nav-icon"><i class="fas fa-house"></i></span><span data-lang-key="navHome">الرئيسية</span>
        </button>
        <button id="navSettingsBtn" class="nav-btn" data-lang-aria-label="navSettingsAria">
            <span class="nav-icon"><i class="fas fa-sliders"></i></span><span data-lang-key="navSettings">الإعدادات</span>
        </button>
        <button id="navAboutBtn" class="nav-btn" data-lang-aria-label="navAboutAria">
            <span class="nav-icon"><i class="fas fa-circle-info"></i></span><span data-lang-key="navAbout">حول</span>
        </button>
    </nav>

    <div id="imageModal" class="image-modal" style="display: none;">
        <span id="closeImageModalBtn" class="close-modal-btn"><i class="fas fa-times"></i></span>
        <img id="modalImageContent" src="" alt="Enlarged Task Image">
    </div>
    
    <footer style="display:none;"> <p><span data-lang-key="developedByFooter">بكل حُب و إتقان من:</span> <span class="dev-name">سند كشنبه Sand Kshnbh</span></p>
    </footer>

    <script>
        // --- Sound Effect (Base64 encoded small pop sound) ---
        const clickSoundBase64 = 'data:audio/mpeg;base64,SUQzBAAAAAAAIBAFVV AlhMAAAAAEIAAAP/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAAExhdmY2MC4zLjEwMAAAAAAAAAAAAAAAD verzekLALkAAAAAElATEFORQEBARChVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoVoKorozaemoniaGQUE/ABIOS3Vo_A6oAUAAYAACABIAAQIBYgAw==';

        // --- UI String Translations ---
        const uiStrings = {
            ar: {
                appName: "Notely",
                addPlaceholder: "اكتب مهمة أساسية...",
                addTaskAriaLabel: "إضافة مهمة",
                taskDetailsTitle: "تفاصيل المهمة",
                notesLabel: "ملاحظات:",
                priorityLabel: "الأولوية:",
                priorityLow: "منخفضة",
                priorityMedium: "متوسطة",
                priorityHigh: "عالية",
                dueDateLabel: "تاريخ الاستحقاق:",
                dueDatePlaceholder: "مثال: الغد، ٢٠ مايو",
                imageLabel: "إرفاق صورة:",
                confirmAddBtn: "تأكيد وإضافة المهمة",
                deleteTaskAriaLabel: "حذف المهمة",
                taskStats: (total, completed) => `الإجمالي: ${total} | المنجز: ${completed}`,
                navHome: "الرئيسية",
                navHomeAria: "الرئيسية",
                navSettings: "الإعدادات",
                navSettingsAria: "الإعدادات",
                navAbout: "حول",
                navAboutAria: "حول التطبيق",
                settingsTitle: "الإعدادات",
                languageLabel: "اللغة:",
                themeLabel: "المظهر:",
                soundLabel: "المؤثرات الصوتية:",
                clearCompletedBtn: "مسح المنجز",
                aboutTitle: "حول Notely",
                version: "الإصدار:",
                developedBy: "تم التطوير بواسطة:",
                appDescriptionShort: "أنيق وبسيط يساعدك على تنظيم مهامك وأفكارك اليومية بكل سهولة وجمال.",
                appMission: "مهمتنا هي توفير أداة مريحة للعين وسهلة الاستخدام تجعل تدوين الملاحظات وإدارة المهام تجربة ممتعة ومنتجة.",
                featuresTitle: "أبرز الميزات:",
                featureAddTask: "إضافة مهام سريعة مع تفاصيل اختيارية (ملاحظات، أولوية، تاريخ استحقاق، صورة مصغرة).",
                featureLangSupport: "دعم لغتين: العربية والإنجليزية.",
                featureThemes: "مظهران: داكن أنيق وفاتح مريح.",
                featureSounds: "مؤثرات صوتية تفاعلية (يمكن إيقافها).",
                featureImagePreview: "معاينة الصور المرفقة بحجم أكبر مع خلفية ضبابية.",
                featureLocalStorage: "حفظ جميع بياناتك محلياً في المتصفح (تعمل بدون انترنت).",
                feedbackWelcome: "نرحب دائماً بآرائكم واقتراحاتكم لتطوير Notely!",
                noTasks: "لا توجد مهام بعد، أضف مهمتك الأولى!",
                imageRemoved: "تمت إزالة الصورة.",
                taskUpdated: "تم تحديث المهمة." // For future editing feature
            },
            en: {
                appName: "Notely",
                addPlaceholder: "Enter main task text...",
                addTaskAriaLabel: "Add Task",
                taskDetailsTitle: "Task Details",
                notesLabel: "Notes:",
                priorityLabel: "Priority:",
                priorityLow: "Low",
                priorityMedium: "Medium",
                priorityHigh: "High",
                dueDateLabel: "Due Date:",
                dueDatePlaceholder: "e.g., Tomorrow, May 20",
                imageLabel: "Attach Image:",
                confirmAddBtn: "Confirm & Add Task",
                deleteTaskAriaLabel: "Delete Task",
                taskStats: (total, completed) => `Total: ${total} | Completed: ${completed}`,
                navHome: "Home",
                navHomeAria: "Home",
                navSettings: "Settings",
                navSettingsAria: "Settings",
                navAbout: "About",
                navAboutAria: "About App",
                settingsTitle: "Settings",
                languageLabel: "Language:",
                themeLabel: "Theme:",
                soundLabel: "Sound Effects:",
                clearCompletedBtn: "Clear Completed",
                aboutTitle: "About Notely",
                version: "Version:",
                developedBy: "Developed with ❤️ by:",
                appDescriptionShort: "is an elegant and simple app to help you organize your daily tasks and thoughts with ease and beauty.",
                appMission: "Our mission is to provide an eye-pleasing and user-friendly tool that makes note-taking and task management an enjoyable and productive experience.",
                featuresTitle: "Key Features:",
                featureAddTask: "Quick task addition with optional details (notes, priority, due date, image thumbnail).",
                featureLangSupport: "Dual language support: Arabic and English.",
                featureThemes: "Two themes: Elegant Dark and Comfortable Light.",
                featureSounds: "Interactive sound effects (toggleable).",
                featureImagePreview: "Enlarged preview for attached images with a blurred background.",
                featureLocalStorage: "All your data is saved locally in your browser (works offline).",
                feedbackWelcome: "We always welcome your feedback and suggestions to improve Notely!",
                noTasks: "No tasks yet, add your first one!",
                imageRemoved: "Image removed.",
                taskUpdated: "Task updated."
            }
        };
        let currentLang = localStorage.getItem('notelyAppLanguage_SK') || 'ar';
        let soundEnabled = JSON.parse(localStorage.getItem('notelySoundEnabled_SK')) !== false; // true by default
        let currentTheme = localStorage.getItem('notelyTheme_SK') || 'dark';


        // --- DOM Elements ---
        const bodyElement = document.body;
        const taskInput = document.getElementById('taskInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskList = document.getElementById('taskList');
        const taskStatsEl = document.getElementById('taskStats');

        const taskDetailsForm = document.getElementById('taskDetailsForm');
        const taskNotesInput = document.getElementById('taskNotesInput');
        const taskPriorityInput = document.getElementById('taskPriorityInput');
        const taskDueDateInput = document.getElementById('taskDueDateInput');
        const taskImageInput = document.getElementById('taskImageInput');
        const confirmAddTaskBtn = document.getElementById('confirmAddTaskBtn');

        const views = {
            home: document.getElementById('homeView'),
            settings: document.getElementById('settingsView'),
            about: document.getElementById('aboutView')
        };

        const navHomeBtn = document.getElementById('navHomeBtn');
        const navSettingsBtn = document.getElementById('navSettingsBtn');
        const navAboutBtn = document.getElementById('navAboutBtn');
        const navButtons = [navHomeBtn, navSettingsBtn, navAboutBtn];

        const languageSwitcher = document.getElementById('languageSwitcher');
        const themeSwitcherToggle = document.getElementById('themeSwitcherToggle');
        const soundToggle = document.getElementById('soundToggle');
        const clearCompletedBtn = document.getElementById('clearCompletedBtn');

        const imageModal = document.getElementById('imageModal');
        const modalImageContent = document.getElementById('modalImageContent');
        const closeImageModalBtn = document.getElementById('closeImageModalBtn');
        
        const clickAudio = new Audio(clickSoundBase64);

        // --- Functions ---

        function playSound() {
            if (soundEnabled) {
                clickAudio.currentTime = 0; // Rewind to start if playing
                clickAudio.play().catch(e => console.warn("Sound play failed:", e));
            }
        }

        function applyTheme() {
            if (currentTheme === 'light') {
                bodyElement.classList.add('light-theme');
                themeSwitcherToggle.checked = true;
            } else {
                bodyElement.classList.remove('light-theme');
                themeSwitcherToggle.checked = false;
            }
            // Update Font Awesome icons for theme if needed (some icons have -regular vs -solid for different weights)
        }


        function applyLanguage() {
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            bodyElement.className = bodyElement.className.replace(/\blang-(ar|en)\b/g, ''); // Remove old lang class
            bodyElement.classList.add(`lang-${currentLang}`);
            
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                const stringSet = uiStrings[currentLang];
                if (stringSet && stringSet[key]) {
                    if (typeof stringSet[key] === 'function') {
                        // Dynamic strings handled elsewhere (e.g. taskStats)
                    } else {
                        el.innerHTML = stringSet[key]; // Use innerHTML for FontAwesome icons if they are part of the string
                    }
                }
            });

            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-placeholder');
                const stringSet = uiStrings[currentLang];
                if (stringSet && stringSet[key]) {
                    el.placeholder = stringSet[key];
                }
            });
            
            document.querySelectorAll('[data-lang-aria-label]').forEach(el => {
                const key = el.getAttribute('data-lang-aria-label');
                const stringSet = uiStrings[currentLang];
                 if (stringSet && stringSet[key]) {
                    el.setAttribute('aria-label', stringSet[key]);
                }
            });
            // Update dynamic texts
            document.title = uiStrings[currentLang].appName || "Notely";
            if(views.home.classList.contains('active')) { // Only update if home is active
                 updateTaskStats();
            }
        }

        function switchView(viewName) {
            playSound();
            Object.values(views).forEach(v => v.classList.remove('active'));
            if (views[viewName]) views[viewName].classList.add('active');

            navButtons.forEach(btn => btn.classList.remove('active'));
            if (viewName === 'home') navHomeBtn.classList.add('active');
            else if (viewName === 'settings') navSettingsBtn.classList.add('active');
            else if (viewName === 'about') navAboutBtn.classList.add('active');

            if(viewName === 'home') updateTaskStats(); // Refresh stats when switching to home
        }
        
        function showTaskDetailsForm() {
            playSound();
            if (taskInput.value.trim() === '') {
                alert(currentLang === 'ar' ? 'اكتبي نص المهمة الأساسي أولاً يا قمر!' : 'Please enter the main task text first, beautiful!');
                taskInput.focus();
                return;
            }
            taskDetailsForm.style.display = 'block';
            taskInput.disabled = true; 
            addTaskBtn.disabled = true;
            taskNotesInput.focus();
        }

        function hideTaskDetailsFormAndReset() {
            taskDetailsForm.style.display = 'none';
            taskNotesInput.value = '';
            taskPriorityInput.value = 'medium';
            taskDueDateInput.value = '';
            taskImageInput.value = null; 
            taskInput.disabled = false;
            addTaskBtn.disabled = false;
            taskInput.focus();
        }

        async function handleConfirmAddTask() {
            playSound();
            const taskText = taskInput.value.trim();
            if (taskText === '') return;

            const notes = taskNotesInput.value.trim();
            const priority = taskPriorityInput.value;
            const dueDate = taskDueDateInput.value.trim();
            let imageSrc = null;

            if (taskImageInput.files && taskImageInput.files[0]) {
                try {
                    imageSrc = await readFileAsDataURL(taskImageInput.files[0]);
                } catch (error) {
                    console.error("Error reading image file:", error);
                    alert(currentLang === 'ar' ? `خطأ تحميل الصورة: ${error.message}. جرب صورة أصغر.` : `Image load error: ${error.message}. Try a smaller image.`);
                }
            }
            
            createTaskElement({ text: taskText, notes, priority, dueDate, imageSrc, completed: false, id: Date.now() });
            taskInput.value = ''; 
            hideTaskDetailsFormAndReset();
            saveTasks();
            updateTaskStats();
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                if (file.size > 1 * 1024 * 1024) { // 1MB limit
                    reject(new Error(currentLang === 'ar' ? 'الصورة كبيرة جداً. الحد الأقصى 1 ميجابايت.' : 'Image is too large. Max 1MB.'));
                    return;
                }
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        function removeImageFromTask(taskId) {
            playSound();
            const tasks = getTasksFromStorage();
            const taskIndex = tasks.findIndex(t => t.id == taskId); // Use == for potential string/number comparison
            if (taskIndex > -1) {
                tasks[taskIndex].imageSrc = null;
                localStorage.setItem('notelyTasks_SK_v3', JSON.stringify(tasks));
                loadTasks(); // Reload to reflect change
                // Add a user feedback message here if desired
            }
        }


        function createTaskElement(task) {
            const li = document.createElement('li');
            li.className = 'task-item';
            li.dataset.id = task.id;
            if (task.completed) li.classList.add('completed');
            
            li.classList.add('fade-in');
            setTimeout(() => { if(li) li.classList.remove('fade-in'); }, 400);

            const mainContent = document.createElement('div');
            mainContent.className = 'task-main-content';

            const taskInfo = document.createElement('div');
            taskInfo.className = 'task-info';

            const checkboxLabel = document.createElement('label');
            checkboxLabel.className = 'checkbox-container';
            const checkboxInput = document.createElement('input');
            checkboxInput.type = 'checkbox';
            checkboxInput.checked = task.completed;
            checkboxInput.addEventListener('change', (e) => { playSound(); toggleTaskCompletion(e); });
            const checkmarkSpan = document.createElement('span');
            checkmarkSpan.className = 'checkmark';
            checkboxLabel.appendChild(checkboxInput);
            checkboxLabel.appendChild(checkmarkSpan);

            const priorityIndicator = document.createElement('div');
            priorityIndicator.className = `priority-indicator priority-${task.priority || 'medium'}`;
            
            const taskTextSpan = document.createElement('span');
            taskTextSpan.className = 'task-text';
            taskTextSpan.textContent = task.text;

            taskInfo.appendChild(checkboxLabel);
            taskInfo.appendChild(priorityIndicator);
            taskInfo.appendChild(taskTextSpan);

            if (task.imageSrc) {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'task-image-container';

                const imgThumbnail = document.createElement('img');
                imgThumbnail.className = 'task-image-thumbnail';
                imgThumbnail.src = task.imageSrc;
                imgThumbnail.alt = currentLang === 'ar' ? "صورة مصغرة للمهمة" : "Task image thumbnail";
                imgThumbnail.addEventListener('click', () => { playSound(); openImageModal(task.imageSrc); });
                
                const removeImgBtn = document.createElement('span');
                removeImgBtn.className = 'remove-image-btn';
                removeImgBtn.innerHTML = '<i class="fas fa-times"></i>'; // Font Awesome X
                removeImgBtn.setAttribute('aria-label', currentLang === 'ar' ? 'إزالة الصورة' : 'Remove image');
                removeImgBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent opening modal
                    removeImageFromTask(task.id);
                };
                
                imgContainer.appendChild(imgThumbnail);
                imgContainer.appendChild(removeImgBtn);
                taskInfo.appendChild(imgContainer);
            }
            
            mainContent.appendChild(taskInfo);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash-can"></i>'; // Font Awesome Trash Can
            deleteBtn.setAttribute('aria-label', uiStrings[currentLang].deleteTaskAriaLabel || 'Delete Task');
            deleteBtn.addEventListener('click', removeTask);
            mainContent.appendChild(deleteBtn);
            
            li.appendChild(mainContent);

            if (task.notes || task.dueDate) {
                const detailsContent = document.createElement('div');
                detailsContent.className = 'task-details-content task-extras';
                if (task.notes) {
                    const notesEl = document.createElement('p');
                    notesEl.className = 'task-notes-display';
                    const notesTitle = uiStrings[currentLang].notesLabel || 'Notes:';
                    notesEl.innerHTML = `<strong>${notesTitle}</strong><br>${task.notes.replace(/\n/g, '<br>')}`;
                    detailsContent.appendChild(notesEl);
                }
                if (task.dueDate) {
                    const dueDateEl = document.createElement('p');
                    const dueDateTitle = uiStrings[currentLang].dueDateLabel || 'Due Date:';
                    dueDateEl.innerHTML = `<strong>${dueDateTitle}</strong> ${task.dueDate}`;
                    detailsContent.appendChild(dueDateEl);
                }
                if (detailsContent.hasChildNodes()) {
                    li.appendChild(detailsContent);
                }
            }
            
            taskList.appendChild(li);
        }

        function toggleTaskCompletion(event) {
            // Sound is played by checkbox event listener
            const taskItem = event.target.closest('.task-item');
            if (taskItem) {
                taskItem.classList.toggle('completed');
                saveTasks();
                updateTaskStats();
            }
        }

        function removeTask(event) {
            playSound();
            const taskItem = event.target.closest('.task-item');
            if (taskItem) {
                taskItem.classList.add('fade-out');
                taskItem.addEventListener('animationend', () => {
                     taskItem.remove();
                     saveTasks();
                     updateTaskStats();
                }, { once: true });
            }
        }
        
        function getTasksFromStorage() {
            return JSON.parse(localStorage.getItem('notelyTasks_SK_v3')) || [];
        }

        function updateTaskStats() {
            const tasks = getTasksFromStorage();
            const allTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.completed).length;
            
            const taskStatsStringKey = 'taskStats';
            if (taskStatsEl && uiStrings[currentLang] && typeof uiStrings[currentLang][taskStatsStringKey] === 'function') {
                 taskStatsEl.textContent = uiStrings[currentLang][taskStatsStringKey](allTasks, completedTasks);
            }

            const noTasksMsgEl = document.getElementById('noTasksMsg');
            if (allTasks === 0 && views.home.classList.contains('active')) {
                 if (!noTasksMsgEl) {
                    const noTasksMsg = document.createElement('p');
                    noTasksMsg.id = 'noTasksMsg';
                    noTasksMsg.textContent = uiStrings[currentLang].noTasks;
                    noTasksMsg.style.textAlign = 'center';
                    noTasksMsg.style.color = 'var(--text-secondary)';
                    noTasksMsg.style.padding = '20px';
                    taskList.parentNode.insertBefore(noTasksMsg, taskList.nextSibling);
                 } else {
                    noTasksMsgEl.textContent = uiStrings[currentLang].noTasks;
                 }
            } else {
                if (noTasksMsgEl) noTasksMsgEl.remove();
            }
        }

        function saveTasks() {
            const tasks = [];
            document.querySelectorAll('.task-list .task-item').forEach(taskItem => {
                const id = taskItem.dataset.id;
                const text = taskItem.querySelector('.task-text').textContent;
                const completed = taskItem.classList.contains('completed');
                
                const priorityIndicator = taskItem.querySelector('.priority-indicator');
                let priority = 'medium';
                if (priorityIndicator) {
                    if(priorityIndicator.classList.contains('priority-high')) priority = 'high';
                    else if(priorityIndicator.classList.contains('priority-low')) priority = 'low';
                }
                
                const notesDisplayEl = taskItem.querySelector('.task-notes-display');
                let notes = '';
                if (notesDisplayEl) {
                    // Extract text after <br>, then replace <br> with \n
                    const brIndex = notesDisplayEl.innerHTML.indexOf('<br>');
                    if (brIndex !== -1) {
                        notes = notesDisplayEl.innerHTML.substring(brIndex + 4).replace(/<br\s*\/?>/gi, '\n').trim();
                    }
                }
                
                const dueDateDisplayEl = taskItem.querySelector('.task-extras p:last-child'); // This logic might need refinement if notes are absent
                let dueDate = '';
                if (dueDateDisplayEl && dueDateDisplayEl.textContent.includes((uiStrings[currentLang].dueDateLabel || 'Due Date:').split(':')[0])) {
                     const parts = dueDateDisplayEl.textContent.split(': ');
                     if (parts.length > 1) dueDate = parts[1].trim();
                }

                const imgThumbnail = taskItem.querySelector('.task-image-thumbnail');
                const imageSrc = imgThumbnail ? imgThumbnail.src : null;

                tasks.push({ id: Number(id), text, completed, notes, priority, dueDate, imageSrc });
            });
            localStorage.setItem('notelyTasks_SK_v3', JSON.stringify(tasks));
        }

        function loadTasks() {
            const storedTasks = getTasksFromStorage();
            taskList.innerHTML = ''; 
            if (storedTasks) {
                storedTasks.forEach(task => createTaskElement(task));
            }
            updateTaskStats();
        }
        
        function clearCompletedTasks() {
            playSound();
            const tasksToKeep = getTasksFromStorage().filter(task => !task.completed);
            localStorage.setItem('notelyTasks_SK_v3', JSON.stringify(tasksToKeep));
            loadTasks();
        }

        function openImageModal(src) {
            playSound();
            modalImageContent.src = src;
            imageModal.style.display = 'flex';
        }
        closeImageModalBtn.onclick = () => { playSound(); imageModal.style.display = 'none'; };
        imageModal.onclick = (e) => { 
            if (e.target === imageModal) {
                playSound();
                imageModal.style.display = 'none';
            }
        };

        // --- Event Listeners ---
        addTaskBtn.addEventListener('click', showTaskDetailsForm);
        confirmAddTaskBtn.addEventListener('click', handleConfirmAddTask);
        taskInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && (!taskDetailsForm.style.display || taskDetailsForm.style.display === 'none') ) {
                showTaskDetailsForm();
            }
        });

        navHomeBtn.addEventListener('click', () => switchView('home'));
        navSettingsBtn.addEventListener('click', () => switchView('settings'));
        navAboutBtn.addEventListener('click', () => switchView('about'));

        languageSwitcher.addEventListener('change', (e) => {
            playSound();
            currentLang = e.target.value;
            localStorage.setItem('notelyAppLanguage_SK', currentLang);
            applyLanguage();
            loadTasks(); 
        });

        themeSwitcherToggle.addEventListener('change', (e) => {
            playSound();
            currentTheme = e.target.checked ? 'light' : 'dark';
            localStorage.setItem('notelyTheme_SK', currentTheme);
            applyTheme();
        });
        
        soundToggle.addEventListener('change', (e) => {
            soundEnabled = e.target.checked;
            localStorage.setItem('notelySoundEnabled_SK', soundEnabled);
            playSound(); // Play a sound to confirm change
        });

        clearCompletedBtn.addEventListener('click', clearCompletedTasks);

        // --- Initial Setup ---
        function initializeApp() {
            // Load preferences
            currentLang = localStorage.getItem('notelyAppLanguage_SK') || 'ar';
            soundEnabled = JSON.parse(localStorage.getItem('notelySoundEnabled_SK')) !== false; // true if not set or true
            currentTheme = localStorage.getItem('notelyTheme_SK') || 'dark';

            // Apply preferences
            languageSwitcher.value = currentLang;
            soundToggle.checked = soundEnabled;
            
            applyTheme(); // Apply theme first as language might depend on it for some styles
            applyLanguage(); // Apply language strings and direction

            switchView('home'); // Default view
            loadTasks(); // Load tasks from storage
        }

        initializeApp();

    </script>
</body>
</html>